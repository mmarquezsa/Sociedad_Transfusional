<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel de AdministraciÃ³n - SOCHIMT</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'sochimt': { 50: '#eff6ff', 100: '#dbeafe', 200: '#bfdbfe', 300: '#93c5fd', 400: '#60a5fa', 500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8', 800: '#1e40af', 900: '#1e3a8a' },
            'medical': { 50: '#fef2f2', 100: '#fee2e2', 200: '#fecaca', 300: '#fca5a5', 400: '#f87171', 500: '#ef4444', 600: '#dc2626', 700: '#b91c1c', 800: '#991b1b', 900: '#7f1d1d' }
          },
          animation: { 'slide-in': 'slideIn 0.3s ease-out', 'fade-in': 'fadeIn 0.5s ease-out', 'bounce-in': 'bounceIn 0.6s ease-out', 'glow': 'glow 2s ease-in-out infinite alternate' }
        }
      }
    }
  </script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap');
    body { font-family: 'Inter', sans-serif; }
    @keyframes slideIn { from { transform: translateX(-100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes bounceIn { 0% { transform: scale(0.3); opacity: 0; } 50% { transform: scale(1.05); } 70% { transform: scale(0.9); } 100% { transform: scale(1); opacity: 1; } }
    @keyframes glow { from { box-shadow: 0 0 20px rgba(37, 99, 235, 0.3); } to { box-shadow: 0 0 30px rgba(37, 99, 235, 0.6); } }
    .gradient-mesh { background: linear-gradient(-45deg, #1e40af, #3b82f6, #dc2626, #ef4444); background-size: 400% 400%; animation: gradientShift 15s ease infinite; }
    @keyframes gradientShift { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
    .glass-morphism { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); }
    .card-hover { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
    .card-hover:hover { transform: translateY(-4px) scale(1.01); box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1); }
    .notification { transition: transform 0.5s ease-in-out, opacity 0.5s ease-in-out; }
    .btn-spinner { display: inline-block; width: 1.2rem; height: 1.2rem; border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: #fff; animation: spin 1s ease-in-out infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .tab-btn.active { border-color: #2563eb; color: #2563eb; font-weight: 700; }
  </style>
</head>
<body class="bg-gradient-to-br from-slate-100 to-blue-100 min-h-screen">

  <div id="login-screen" class="min-h-screen flex items-center justify-center p-4">
    <div class="bg-white/80 backdrop-blur-lg p-8 rounded-3xl shadow-2xl max-w-md w-full border border-white/20">
      <div class="text-center mb-8 animate-bounce-in">
        <div class="h-24 w-24 bg-white rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-lg animate-glow p-4">
          <img src="images/logos/_ Main Logo 1.3.png" alt="SOCHIMT Logo" class="w-full h-full object-contain">
        </div>
        <h1 class="text-3xl font-black text-gray-800 mb-2">Panel Administrativo</h1>
        <p class="text-gray-600 font-medium">SOCHIMT - GestiÃ³n de Contenido</p>
        <div class="w-20 h-1 bg-gradient-to-r from-sochimt-600 to-medical-600 rounded-full mx-auto mt-4"></div>
      </div>
      <form id="login-form" class="space-y-6">
        <div><label for="username" class="block text-sm font-bold text-gray-700 mb-2">ğŸ‘¤ Usuario</label><input type="text" id="username" required class="w-full px-6 py-4 border-2 border-gray-200 rounded-xl focus:ring-4 focus:ring-sochimt-200 focus:border-sochimt-500 transition-all"></div>
        <div><label for="password" class="block text-sm font-bold text-gray-700 mb-2">ğŸ” ContraseÃ±a</label><input type="password" id="password" required class="w-full px-6 py-4 border-2 border-gray-200 rounded-xl focus:ring-4 focus:ring-sochimt-200 focus:border-sochimt-500 transition-all"></div>
        <button type="submit" id="login-btn" class="w-full bg-gradient-to-r from-sochimt-600 to-sochimt-700 text-white py-4 px-6 rounded-xl hover:from-sochimt-700 hover:to-sochimt-800 transition-all duration-300 font-bold text-lg shadow-lg hover:shadow-xl transform hover:scale-105">âœ¨ Acceder al Panel</button>
      </form>
      <div id="login-error" class="hidden mt-6 p-4 bg-red-100 border-l-4 border-red-500 text-red-700 rounded-lg animate-fade-in"><div class="flex items-center"><span class="text-xl mr-2">âš ï¸</span><span>Usuario o contraseÃ±a incorrectos</span></div></div>
    </div>
  </div>

  <div id="admin-panel" class="hidden min-h-screen">
    <header class="bg-white/90 backdrop-blur-lg shadow-lg border-b border-white/20 sticky top-0 z-50">
      <div class="max-w-7xl mx-auto px-6 py-4"><div class="flex justify-between items-center"><div class="flex items-center space-x-4"><div class="h-12 w-12 bg-white rounded-xl flex items-center justify-center shadow-lg p-1.5"><img src="images/logos/_ Main Logo 1.3.png" alt="SOCHIMT Logo" class="w-full h-full object-contain"></div><div><h1 class="text-2xl font-black text-gray-800">Panel de AdministraciÃ³n</h1><p class="text-sm text-gray-600 font-medium">GestiÃ³n de Noticias SOCHIMT</p></div></div><div class="flex items-center space-x-6">
        <div id="connection-status" class="flex items-center space-x-2 px-3 py-1 bg-gray-200 rounded-full text-sm font-medium text-gray-600">
            <div id="status-dot" class="w-3 h-3 rounded-full bg-gray-400"></div>
            <span id="status-text">Desconectado</span>
        </div>
        <div class="text-right"><span class="text-sm text-gray-600">Bienvenido,</span> <span id="current-user" class="font-bold text-sochimt-600"></span></div><button id="logout-btn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-medium transition-all duration-300 transform hover:scale-105">ğŸšª Salir</button></div></div></div>
    </header>

    <main class="max-w-7xl mx-auto px-6 py-8">
      <div class="mb-8"><div class="border-b border-gray-200"><nav class="-mb-px flex space-x-8"><button class="tab-btn active border-b-2 py-2 px-1 font-medium text-sm" data-tab="dashboard">ğŸ“Š Dashboard</button><button class="tab-btn border-b-2 border-transparent text-gray-500 hover:text-gray-700 py-2 px-1 font-medium text-sm" data-tab="noticias">ğŸ“° Gestionar Noticias</button><button class="tab-btn border-b-2 border-transparent text-gray-500 hover:text-gray-700 py-2 px-1 font-medium text-sm" data-tab="configuracion">âš™ï¸ ConfiguraciÃ³n</button></nav></div></div>
      
      <div id="tab-dashboard" class="tab-content animate-fade-in"><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8"><div class="bg-gradient-to-br from-blue-500 to-blue-600 p-6 rounded-2xl text-white card-hover"><div class="flex items-center justify-between"><div><p class="text-blue-100 font-medium">Total Noticias</p><p class="text-3xl font-black" id="total-news">0</p></div><div class="text-4xl opacity-80">ğŸ“°</div></div></div><div class="bg-gradient-to-br from-green-500 to-green-600 p-6 rounded-2xl text-white card-hover"><div class="flex items-center justify-between"><div><p class="text-green-100 font-medium">Este Mes</p><p class="text-3xl font-black" id="recent-news">0</p></div><div class="text-4xl opacity-80">ğŸ“…</div></div></div><div class="bg-gradient-to-br from-purple-500 to-purple-600 p-6 rounded-2xl text-white card-hover"><div class="flex items-center justify-between"><div><p class="text-purple-100 font-medium">CategorÃ­as</p><p class="text-3xl font-black" id="categories-count">0</p></div><div class="text-4xl opacity-80">ğŸ·ï¸</div></div></div><div class="bg-gradient-to-br from-orange-500 to-orange-600 p-6 rounded-2xl text-white card-hover"><div class="flex items-center justify-between"><div><p class="text-orange-100 font-medium">Usuarios</p><p class="text-3xl font-black" id="users-count">0</p></div><div class="text-4xl opacity-80">ğŸ‘¥</div></div></div></div><div class="bg-white/80 backdrop-blur-lg rounded-3xl shadow-xl p-8 border"><h2 class="text-2xl font-black text-gray-800 mb-6">ğŸš€ Acciones RÃ¡pidas</h2><div class="grid grid-cols-1 md:grid-cols-3 gap-6"><button onclick="switchTab('noticias')" class="p-6 bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl border-2 border-blue-200 hover:border-blue-300 text-left card-hover"><div class="text-3xl mb-3">ğŸ“</div><h3 class="font-bold text-gray-800 mb-2">Nueva Noticia</h3><p class="text-sm text-gray-600">Agregar una nueva noticia al sitio</p></button><button onclick="switchTab('configuracion')" class="p-6 bg-gradient-to-br from-green-50 to-green-100 rounded-xl border-2 border-green-200 hover:border-green-300 text-left card-hover"><div class="text-3xl mb-3">ğŸ”</div><h3 class="font-bold text-gray-800 mb-2">Cambiar ContraseÃ±a</h3><p class="text-sm text-gray-600">Actualizar credenciales de acceso</p></button><button id="export-data-btn" class="p-6 bg-gradient-to-br from-purple-50 to-purple-100 rounded-xl border-2 border-purple-200 hover:border-purple-300 text-left card-hover"><div class="text-3xl mb-3">ğŸ“¤</div><h3 class="font-bold text-gray-800 mb-2">Exportar Datos</h3><p class="text-sm text-gray-600">Descargar backup de noticias</p></button></div></div></div>
      
      <div id="tab-noticias" class="tab-content hidden animate-fade-in">
        <div class="bg-white/80 backdrop-blur-lg rounded-3xl shadow-xl p-8 mb-8 border">
          <h2 class="text-2xl font-black text-gray-800 mb-6" id="form-title">Agregar Nueva Noticia</h2>
          <form id="news-form" class="space-y-6">
            <input type="hidden" id="news-id">
            <input type="hidden" id="existing-image-url">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <div><label for="news-title" class="block text-sm font-bold text-gray-700 mb-3">ğŸ“ TÃ­tulo *</label><input type="text" id="news-title" required class="w-full px-6 py-4 border-2 border-gray-200 rounded-xl" placeholder="Ingresa el tÃ­tulo..."></div>
              <div><label for="news-category" class="block text-sm font-bold text-gray-700 mb-3">ğŸ·ï¸ CategorÃ­a *</label><select id="news-category" required class="w-full px-6 py-4 border-2 border-gray-200 rounded-xl"><option value="">Seleccionar categorÃ­a</option><option value="Evento">ğŸ‰ Evento</option><option value="PublicaciÃ³n">ğŸ“š PublicaciÃ³n</option><option value="Webinar">ğŸ’» Webinar</option><option value="Congreso">ğŸ›ï¸ Congreso</option><option value="Noticia">ğŸ“° Noticia General</option></select></div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <div><label for="news-date" class="block text-sm font-bold text-gray-700 mb-3">ğŸ“… Fecha *</label><input type="date" id="news-date" required class="w-full px-6 py-4 border-2 border-gray-200 rounded-xl"></div>
              <div><label for="news-url" class="block text-sm font-bold text-gray-700 mb-3">ğŸ”— URL (opcional)</label><input type="url" id="news-url" placeholder="https://..." class="w-full px-6 py-4 border-2 border-gray-200 rounded-xl"></div>
            </div>
            <div><label class="block text-sm font-bold text-gray-700 mb-3">ğŸ–¼ï¸ Imagen o Video</label><div class="border-2 border-dashed border-gray-300 rounded-xl p-6 text-center hover:border-sochimt-500"><input type="file" id="news-image-file" accept="image/*,video/*" class="hidden"><div id="file-upload-area" class="cursor-pointer"><div class="text-4xl mb-4">ğŸ“</div><p class="font-medium mb-2">Haz clic para seleccionar archivo</p><p class="text-sm text-gray-500">MÃ¡x. 50MB</p></div><div id="file-preview" class="hidden mt-4"><div id="preview-content"></div><button type="button" id="remove-file-btn" class="mt-3 px-4 py-2 bg-red-500 text-white rounded-lg text-sm hover:bg-red-600">ğŸ—‘ï¸ Quitar archivo</button></div></div></div>
            <div><label for="news-summary" class="block text-sm font-bold text-gray-700 mb-3">ğŸ“„ Resumen *</label><textarea id="news-summary" rows="4" required class="w-full px-6 py-4 border-2 border-gray-200 rounded-xl resize-none" placeholder="Describe la noticia..."></textarea></div>
            <div class="flex justify-end space-x-4"><button type="button" id="cancel-edit" class="hidden px-8 py-3 border-2 text-gray-700 rounded-xl font-medium">âŒ Cancelar</button><button type="submit" id="submit-news" class="px-8 py-3 bg-gradient-to-r from-sochimt-600 to-sochimt-700 text-white rounded-xl font-bold">âœ¨ Publicar Noticia</button></div>
          </form>
        </div>

        <!-- NUEVA SECCIÃ“N: Filtros Mejorados -->
        <div class="bg-white/80 backdrop-blur-lg rounded-3xl shadow-xl p-8 mb-8 border">
          <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-6">
            <h2 class="text-2xl font-black text-gray-800">ğŸ“‹ Todas las Noticias <span id="news-count" class="text-lg font-normal text-gray-600">(0)</span></h2>
            
            <!-- Filtros -->
            <div class="flex flex-col sm:flex-row gap-4">
              <!-- BÃºsqueda -->
              <div class="relative">
                <input type="text" id="search-input" placeholder="ğŸ” Buscar por tÃ­tulo..." class="pl-4 pr-4 py-2 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-sochimt-500 w-full sm:w-64">
              </div>
              
              <!-- Filtro por categorÃ­a -->
              <select id="category-filter" class="px-4 py-2 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-sochimt-500">
                <option value="">ğŸ·ï¸ Todas las categorÃ­as</option>
                <option value="Evento">ğŸ‰ Eventos</option>
                <option value="PublicaciÃ³n">ğŸ“š Publicaciones</option>
                <option value="Webinar">ğŸ’» Webinars</option>
                <option value="Congreso">ğŸ›ï¸ Congresos</option>
                <option value="Noticia">ğŸ“° Noticias</option>
              </select>
              
              <!-- Filtro por mes -->
              <select id="month-filter" class="px-4 py-2 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-sochimt-500">
                <option value="">ğŸ“… Todos los meses</option>
                <option value="2025-01">Enero 2025</option>
                <option value="2025-02">Febrero 2025</option>
                <option value="2025-03">Marzo 2025</option>
                <option value="2025-04">Abril 2025</option>
                <option value="2025-05">Mayo 2025</option>
                <option value="2025-06">Junio 2025</option>
                <option value="2025-07">Julio 2025</option>
                <option value="2025-08">Agosto 2025</option>
                <option value="2025-09">Septiembre 2025</option>
                <option value="2025-10">Octubre 2025</option>
                <option value="2025-11">Noviembre 2025</option>
                <option value="2025-12">Diciembre 2025</option>
              </select>
              
              <!-- BotÃ³n limpiar filtros -->
              <button id="clear-filters" class="px-4 py-2 bg-gray-500 text-white rounded-xl hover:bg-gray-600 transition-colors">
                ğŸ—‘ï¸ Limpiar
              </button>
            </div>
          </div>
        </div>

        <!-- Lista de noticias con paginaciÃ³n -->
        <div class="bg-white/80 backdrop-blur-lg rounded-3xl shadow-xl p-8 border">
          <div id="news-list" class="space-y-6 mb-6"></div>
          
          <!-- PaginaciÃ³n -->
          <div id="pagination" class="flex justify-center items-center space-x-4 mt-8">
            <button id="prev-page" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors disabled:opacity-50" disabled>
              â† Anterior
            </button>
            <span id="page-info" class="text-gray-600 font-medium">PÃ¡gina 1 de 1</span>
            <button id="next-page" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors disabled:opacity-50" disabled>
              Siguiente â†’
            </button>
          </div>
        </div>
      </div>
      
      <div id="tab-configuracion" class="tab-content hidden animate-fade-in"><div class="grid grid-cols-1 lg:grid-cols-2 gap-8"><div class="bg-white/80 backdrop-blur-lg rounded-3xl shadow-xl p-8 border"><h2 class="text-2xl font-black text-gray-800 mb-6">Cambiar ContraseÃ±a</h2><form id="change-password-form" class="space-y-6"><div><label for="current-password" class="block text-sm font-bold text-gray-700 mb-3">ğŸ”‘ ContraseÃ±a Actual *</label><input type="password" id="current-password" required class="w-full px-6 py-4 border-2 rounded-xl" placeholder="Ingresa tu contraseÃ±a actual"></div><div><label for="new-password" class="block text-sm font-bold text-gray-700 mb-3">ğŸ†• Nueva ContraseÃ±a *</label><input type="password" id="new-password" required class="w-full px-6 py-4 border-2 rounded-xl" placeholder="MÃ­nimo 6 caracteres"></div><div><label for="confirm-password" class="block text-sm font-bold text-gray-700 mb-3">âœ… Confirmar ContraseÃ±a *</label><input type="password" id="confirm-password" required class="w-full px-6 py-4 border-2 rounded-xl" placeholder="Repite la nueva contraseÃ±a"></div><button type="submit" class="w-full px-8 py-4 bg-gradient-to-r from-medical-600 to-medical-700 text-white rounded-xl font-bold">ğŸ”„ Actualizar</button></form></div><div class="bg-white/80 backdrop-blur-lg rounded-3xl shadow-xl p-8 border"><h2 class="text-2xl font-black text-gray-800 mb-6">GestiÃ³n de Usuarios</h2><div id="users-list" class="space-y-4"></div></div></div></div>
    </main>
  </div>

  <div id="notification" class="notification fixed top-5 right-5 p-4 rounded-lg shadow-lg text-white transform translate-x-[120%] opacity-0"></div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    // ConfiguraciÃ³n de Supabase
    const SUPABASE_URL = 'https://dkohwhosputnxismgkon.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRrb2h3aG9zcHV0bnhpc21na29uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTAwMzkxMTQsImV4cCI6MjA2NTYxNTExNH0.2ZOwkilUv49SADBzjrq-4AHUUKnMLZs-beftr3FLdAE';
    
    const { createClient } = supabase;
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);
    
    const BUCKET_NAME = 'media';

    // Variables globales
    let selectedFile = null; 
    let currentUser = null; 
    let allNewsData = []; // Todos los datos
    let filteredNewsData = []; // Datos filtrados
    let currentPage = 1;
    const itemsPerPage = 5;
    
    const USERS = { 'admin': 'marcelo', 'editora': 'silvia' };

    // DOM Elements
    const dom = {
      loginScreen: document.getElementById('login-screen'),
      adminPanel: document.getElementById('admin-panel'),
      loginForm: document.getElementById('login-form'),
      newsForm: document.getElementById('news-form'),
      newsList: document.getElementById('news-list'),
      logoutBtn: document.getElementById('logout-btn'),
      cancelEditBtn: document.getElementById('cancel-edit'),
      submitBtn: document.getElementById('submit-news'),
      formTitle: document.getElementById('form-title'),
      fileInput: document.getElementById('news-image-file'),
      fileUploadArea: document.getElementById('file-upload-area'),
      filePreview: document.getElementById('file-preview'),
      previewContent: document.getElementById('preview-content'),
      removeFileBtn: document.getElementById('remove-file-btn'),
      currentUserSpan: document.getElementById('current-user'),
      loginError: document.getElementById('login-error'),
      tabs: document.querySelectorAll('.tab-btn'),
      tabContents: document.querySelectorAll('.tab-content'),
      usersList: document.getElementById('users-list'),
      changePasswordForm: document.getElementById('change-password-form'),
      exportBtn: document.getElementById('export-data-btn'),
      statusDot: document.getElementById('status-dot'),
      statusText: document.getElementById('status-text'),
      // Nuevos elementos de filtros
      searchInput: document.getElementById('search-input'),
      categoryFilter: document.getElementById('category-filter'),
      monthFilter: document.getElementById('month-filter'),
      clearFilters: document.getElementById('clear-filters'),
      newsCount: document.getElementById('news-count'),
      prevPage: document.getElementById('prev-page'),
      nextPage: document.getElementById('next-page'),
      pageInfo: document.getElementById('page-info'),
      stats: {
        total: document.getElementById('total-news'),
        recent: document.getElementById('recent-news'),
        categories: document.getElementById('categories-count'),
        users: document.getElementById('users-count')
      }
    };
    
    // FunciÃ³n para obtener Ã­cono por categorÃ­a
    function getCategoryIcon(categoria) {
      const icons = {
        'Evento': 'ğŸ‰',
        'PublicaciÃ³n': 'ğŸ“š',
        'Webinar': 'ğŸ’»',
        'Congreso': 'ğŸ›ï¸',
        'Noticia': 'ğŸ“°'
      };
      return icons[categoria] || 'ğŸ“°';
    }

    // FunciÃ³n para obtener color por categorÃ­a
    function getCategoryColor(categoria) {
      const colors = {
        'Evento': 'bg-purple-100 text-purple-800',
        'PublicaciÃ³n': 'bg-blue-100 text-blue-800',
        'Webinar': 'bg-green-100 text-green-800',
        'Congreso': 'bg-orange-100 text-orange-800',
        'Noticia': 'bg-gray-100 text-gray-800'
      };
      return colors[categoria] || 'bg-gray-100 text-gray-800';
    }
    
    // Event Listeners
    dom.loginForm.addEventListener('submit', (e) => { 
      e.preventDefault(); 
      const u = dom.loginForm.username.value, p = dom.loginForm.password.value; 
      if (USERS[u] && USERS[u] === p) { 
        sessionStorage.setItem('sochimtUser', u); 
        initAdminPanel(); 
      } else { 
        dom.loginError.classList.remove('hidden'); 
      } 
    });
    
    dom.logoutBtn.addEventListener('click', () => { 
      sessionStorage.removeItem('sochimtUser'); 
      dom.adminPanel.classList.add('hidden'); 
      dom.loginScreen.classList.remove('hidden'); 
    });
    
    function checkSession() { 
      if (sessionStorage.getItem('sochimtUser')) initAdminPanel(); 
    }
    
    function initAdminPanel() { 
      currentUser = sessionStorage.getItem('sochimtUser'); 
      dom.currentUserSpan.textContent = currentUser; 
      dom.loginScreen.classList.add('hidden'); 
      dom.adminPanel.classList.remove('hidden'); 
      setupEventListeners(); 
      loadNews(); 
      setDefaultDate(); 
      loadUsersList(); 
    }
    
    function cancelEdit() {
      dom.newsForm.reset();
      removeFile();
      dom.formTitle.textContent = 'Agregar Nueva Noticia';
      dom.submitBtn.innerHTML = 'âœ¨ Publicar Noticia';
      dom.cancelEditBtn.classList.add('hidden');
      setDefaultDate();
    }
    
    function setupEventListeners() { 
      dom.newsForm.addEventListener('submit', handleNewsSubmit); 
      dom.cancelEditBtn.addEventListener('click', cancelEdit); 
      dom.fileUploadArea.addEventListener('click', () => dom.fileInput.click()); 
      dom.fileInput.addEventListener('change', () => handleFileUpload(dom.fileInput)); 
      dom.removeFileBtn.addEventListener('click', removeFile); 
      dom.tabs.forEach(tab => tab.addEventListener('click', () => switchTab(tab.dataset.tab))); 
      dom.changePasswordForm.addEventListener('submit', handlePasswordChange); 
      dom.exportBtn.addEventListener('click', exportData);
      
      // Nuevos event listeners para filtros
      dom.searchInput.addEventListener('input', applyFilters);
      dom.categoryFilter.addEventListener('change', applyFilters);
      dom.monthFilter.addEventListener('change', applyFilters);
      dom.clearFilters.addEventListener('click', clearAllFilters);
      dom.prevPage.addEventListener('click', () => changePage(-1));
      dom.nextPage.addEventListener('click', () => changePage(1));
    }
    
    function formatDate(dateStr) { 
      if (!dateStr) return ''; 
      const d = new Date(dateStr); 
      d.setMinutes(d.getMinutes() + d.getTimezoneOffset()); 
      return d.toLocaleDateString('es-CL', { year: 'numeric', month: 'long', day: 'numeric' }); 
    }
    
    // FunciÃ³n principal para cargar noticias (SIN LÃMITE)
    async function loadNews() {
      updateConnectionStatus('connecting');
      dom.newsList.innerHTML = '<p class="text-center text-gray-500 py-8">Cargando noticias...</p>';
      
      try {
        const { data, error } = await supabaseClient
          .from('noticias')
          .select('*')
          .order('fecha', { ascending: false }); // SIN .limit() para obtener TODAS

        if (error) {
          updateConnectionStatus('disconnected');
          dom.newsList.innerHTML = `<p class="text-red-500">Error al cargar: ${error.message}</p>`;
          console.error('Error loading news:', error);
          return;
        }

        updateConnectionStatus('connected');
        
        allNewsData = data || [];
        console.log(`ğŸ“Š Total noticias cargadas: ${allNewsData.length}`);
        
        if (allNewsData.length === 0) {
          dom.newsList.innerHTML = '<p class="text-center text-gray-500 py-8">No hay noticias. Â¡Agrega la primera!</p>';
          updateStats([]);
          return;
        }
        
        // Aplicar filtros y mostrar
        applyFilters();
        updateStats(allNewsData);
        
      } catch (error) {
        updateConnectionStatus('disconnected');
        console.error('Error loading news:', error);
        dom.newsList.innerHTML = `<p class="text-red-500">Error: ${error.message}</p>`;
      }
    }

    // Nueva funciÃ³n para aplicar filtros
    function applyFilters() {
      const searchTerm = dom.searchInput.value.toLowerCase();
      const categoryFilter = dom.categoryFilter.value;
      const monthFilter = dom.monthFilter.value;
      
      filteredNewsData = allNewsData.filter(news => {
        // Filtro por bÃºsqueda
        const matchesSearch = !searchTerm || 
          news.titulo.toLowerCase().includes(searchTerm) ||
          (news.resumen && news.resumen.toLowerCase().includes(searchTerm));
        
        // Filtro por categorÃ­a
        const matchesCategory = !categoryFilter || news.categoria === categoryFilter;
        
        // Filtro por mes
        const matchesMonth = !monthFilter || news.fecha.startsWith(monthFilter);
        
        return matchesSearch && matchesCategory && matchesMonth;
      });
      
      console.log(`ğŸ” Filtros aplicados: ${filteredNewsData.length} de ${allNewsData.length} noticias`);
      
      // Resetear a primera pÃ¡gina
      currentPage = 1;
      displayNews();
    }

    // Nueva funciÃ³n para mostrar noticias con paginaciÃ³n
    function displayNews() {
      dom.newsCount.textContent = `(${filteredNewsData.length})`;
      
      if (filteredNewsData.length === 0) {
        dom.newsList.innerHTML = '<p class="text-center text-gray-500 py-8">No se encontraron noticias con los filtros aplicados.</p>';
        updatePagination(0, 0);
        return;
      }
      
      // Calcular elementos para la pÃ¡gina actual
      const startIndex = (currentPage - 1) * itemsPerPage;
      const endIndex = startIndex + itemsPerPage;
      const pageData = filteredNewsData.slice(startIndex, endIndex);
      
      // Mostrar noticias de la pÃ¡gina actual
      dom.newsList.innerHTML = pageData.map(news => createNewsHTML(news)).join('');
      
      // Actualizar paginaciÃ³n
      const totalPages = Math.ceil(filteredNewsData.length / itemsPerPage);
      updatePagination(currentPage, totalPages);
    }

    function createNewsHTML(news) {
      return `
        <div class="bg-white/60 backdrop-blur-sm rounded-2xl border-2 border-gray-100 hover:border-blue-300 hover:shadow-xl transition-all duration-300 overflow-hidden card-hover">
          <div class="flex flex-col md:flex-row">
            <!-- Imagen -->
            <div class="md:w-1/3 lg:w-1/4 relative">
              ${news.url_media ? `
                <img src="${news.url_media}" 
                     alt="${news.titulo}" 
                     class="w-full h-48 md:h-full object-cover" 
                     onerror="this.src='https://images.unsplash.com/photo-1576091160399-112ba8d25d1f?w=400&h=250&fit=crop'; this.classList.add('opacity-50');">
              ` : `
                <div class="w-full h-48 md:h-full bg-gradient-to-br from-gray-200 to-gray-300 flex items-center justify-center">
                  <div class="text-center text-gray-500">
                    <svg class="w-12 h-12 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                    <p class="text-xs">Sin imagen</p>
                  </div>
                </div>
              `}
              <div class="absolute top-3 left-3">
                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-bold ${getCategoryColor(news.categoria)}">
                  ${getCategoryIcon(news.categoria)} ${news.categoria}
                </span>
              </div>
            </div>
            
            <!-- Contenido -->
            <div class="flex-1 p-6">
              <div class="flex justify-between items-start mb-4">
                <div class="flex-1 pr-4">
                  <h3 class="text-xl font-bold text-gray-800 mb-2 line-clamp-2">${news.titulo}</h3>
                  <p class="text-gray-600 text-sm mb-3 line-clamp-2">${news.resumen || 'Sin descripciÃ³n'}</p>
                  
                  <div class="flex flex-wrap items-center gap-4 text-sm text-gray-500">
                    <div class="flex items-center">
                      <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                      </svg>
                      ${formatDate(news.fecha)}
                    </div>
                    
                    ${news.url_externa ? `
                      <div class="flex items-center">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                        </svg>
                        <a href="${news.url_externa}" target="_blank" class="text-blue-600 hover:text-blue-800">Ver enlace</a>
                      </div>
                    ` : ''}
                    
                    <div class="flex items-center">
                      <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                      </svg>
                      ID: ${news.id}
                    </div>

                    ${news.url_media ? `
                      <div class="flex items-center text-green-600">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                        </svg>
                        Con imagen
                      </div>
                    ` : `
                      <div class="flex items-center text-gray-400">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                        </svg>
                        Sin imagen
                      </div>
                    `}
                  </div>
                </div>
                
                <!-- Botones de acciÃ³n -->
                <div class="flex flex-col space-y-2 flex-shrink-0">
                  <button onclick="editNews(${news.id})" 
                          class="p-3 bg-gradient-to-r from-yellow-400 to-yellow-500 text-white rounded-xl hover:from-yellow-500 hover:to-yellow-600 transition-all shadow-lg transform hover:scale-105" 
                          title="Editar noticia">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                    </svg>
                  </button>
                  <button onclick="deleteNews(${news.id})" 
                          class="p-3 bg-gradient-to-r from-red-500 to-red-600 text-white rounded-xl hover:from-red-600 hover:to-red-700 transition-all shadow-lg transform hover:scale-105" 
                          title="Eliminar noticia">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                    </svg>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>`;
    }

    // FunciÃ³n para limpiar filtros
    function clearAllFilters() {
      dom.searchInput.value = '';
      dom.categoryFilter.value = '';
      dom.monthFilter.value = '';
      applyFilters();
    }

    // FunciÃ³n para cambiar pÃ¡gina
    function changePage(direction) {
      const totalPages = Math.ceil(filteredNewsData.length / itemsPerPage);
      const newPage = currentPage + direction;
      
      if (newPage >= 1 && newPage <= totalPages) {
        currentPage = newPage;
        displayNews();
      }
    }

    // FunciÃ³n para actualizar paginaciÃ³n
    function updatePagination(current, total) {
      dom.pageInfo.textContent = `PÃ¡gina ${current} de ${total}`;
      dom.prevPage.disabled = current <= 1;
      dom.nextPage.disabled = current >= total;
      
      if (total <= 1) {
        document.getElementById('pagination').style.display = 'none';
      } else {
        document.getElementById('pagination').style.display = 'flex';
      }
    }

    // Resto de funciones existentes...
    async function handleNewsSubmit(e) {
      e.preventDefault();
      dom.submitBtn.disabled = true;
      dom.submitBtn.innerHTML = '<span class="btn-spinner"></span>';
      const id = dom.newsForm['news-id'].value;
      let urlMedia = dom.newsForm['existing-image-url'].value || null;

      try {
        if (selectedFile) {
          if (id && urlMedia) {
            const oldFilePath = urlMedia.substring(urlMedia.indexOf(BUCKET_NAME + '/') + (BUCKET_NAME.length + 1));
            await supabaseClient.storage.from(BUCKET_NAME).remove([oldFilePath]);
          }
          
          const filePath = `public/${Date.now()}_${selectedFile.name}`;
          const { error: uploadError, data: uploadData } = await supabaseClient.storage
            .from(BUCKET_NAME)
            .upload(filePath, selectedFile);

          if (uploadError) throw uploadError;
          
          const { data: publicUrlData } = supabaseClient.storage
            .from(BUCKET_NAME)
            .getPublicUrl(filePath);
          
          urlMedia = publicUrlData.publicUrl;
        }

        const newsData = {
          titulo: dom.newsForm['news-title'].value,
          categoria: dom.newsForm['news-category'].value,
          fecha: dom.newsForm['news-date'].value,
          resumen: dom.newsForm['news-summary'].value,
          contenido: dom.newsForm['news-summary'].value, 
          url_externa: dom.newsForm['news-url'].value || null,
          url_media: urlMedia
        };
        
        let error;
        if (id) {
          const { error: updateError } = await supabaseClient.from('noticias').update(newsData).eq('id', id);
          error = updateError;
        } else {
          const { error: insertError } = await supabaseClient.from('noticias').insert([newsData]);
          error = insertError;
        }

        if (error) throw error;

        showNotification(id ? 'âœ… Noticia actualizada' : 'ğŸ‰ Noticia publicada', 'success');
        cancelEdit();
        await loadNews(); // Recargar todas las noticias

      } catch (err) { 
        showNotification(`âŒ Error: ${err.message}`, 'error'); 
      } finally { 
        dom.submitBtn.disabled = false; 
        dom.submitBtn.innerHTML = id ? 'ğŸ”„ Actualizar Noticia' : 'âœ¨ Publicar Noticia'; 
      }
    }

    window.editNews = async (id) => {
      try {
        const { data: news, error } = await supabaseClient.from('noticias').select('*').eq('id', id).single();
        if (error) throw error;
        if (!news) return;

        dom.newsForm['news-id'].value = news.id;
        dom.newsForm['news-title'].value = news.titulo;
        dom.newsForm['news-category'].value = news.categoria;
        dom.newsForm['news-date'].value = news.fecha;
        dom.newsForm['news-summary'].value = news.resumen;
        dom.newsForm['news-url'].value = news.url_externa || '';
        
        removeFile();
        if (news.url_media) {
          dom.newsForm['existing-image-url'].value = news.url_media;
          showFilePreview({name: 'Imagen guardada', type: 'image/'}, news.url_media);
        }
        
        dom.formTitle.textContent = 'Editando Noticia';
        dom.submitBtn.innerHTML = 'ğŸ”„ Actualizar Noticia';
        dom.cancelEditBtn.classList.remove('hidden');
        switchTab('noticias');
        window.scrollTo({ top: 0, behavior: 'smooth' });
      } catch (error) {
        showNotification('âŒ Error al cargar para editar', 'error');
        console.error(error);
      }
    }

    window.deleteNews = async (id) => {
      if (confirm('Â¿EstÃ¡s seguro? Esta acciÃ³n no se puede deshacer.')) {
        try {
          const { data: news, error: fetchError } = await supabaseClient.from('noticias').select('url_media').eq('id', id).single();
          if (fetchError && fetchError.code !== 'PGRST116') throw fetchError;

          if (news && news.url_media) {
            const filePath = news.url_media.substring(news.url_media.indexOf(BUCKET_NAME + '/') + (BUCKET_NAME.length + 1));
            await supabaseClient.storage.from(BUCKET_NAME).remove([filePath]);
          }

          const { error: deleteError } = await supabaseClient.from('noticias').delete().eq('id', id);
          if (deleteError) throw deleteError;
          
          showNotification('ğŸ—‘ï¸ Noticia eliminada', 'success');
          await loadNews(); // Recargar todas las noticias

        } catch (err) {
          showNotification(`âŒ Error al eliminar: ${err.message}`, 'error');
          console.error(err);
        }
      }
    }

    function handleFileUpload(input) { 
      const file = input.files[0]; 
      if (!file) return; 
      if (file.size > 50 * 1024 * 1024) { 
        showNotification('âŒ Archivo > 50MB', 'error'); 
        return; 
      } 
      selectedFile = file; 
      const reader = new FileReader(); 
      reader.onload = e => showFilePreview(file, e.target.result); 
      reader.readAsDataURL(file); 
    }
    
    function showFilePreview(file, dataUrl) { 
      dom.fileUploadArea.classList.add('hidden'); 
      dom.filePreview.classList.remove('hidden'); 
      
      const isUrl = typeof dataUrl === 'string' && dataUrl.startsWith('http');
      const fileName = isUrl ? 'Imagen guardada' : file.name;
      
      let el;
      if (isUrl) {
        el = `<img src="${dataUrl}" class="max-h-48 rounded-lg mx-auto border shadow-lg" onerror="this.src='https://images.unsplash.com/photo-1559757148-5c350d0d3c56?w=400&h=250&fit=crop'">`;
      } else if (file.type.startsWith('image/')) {
        el = `<img src="${dataUrl}" class="max-h-48 rounded-lg mx-auto border shadow-lg">`;
      } else {
        el = `<video src="${dataUrl}" controls class="max-h-48 rounded-lg mx-auto border shadow-lg"></video>`;
      }
      
      dom.previewContent.innerHTML = `${el}<p class="mt-2 text-sm text-gray-500 font-medium">${fileName}</p>`; 
    }
    
    function removeFile() { 
      dom.fileInput.value = ''; 
      selectedFile = null; 
      dom.fileUploadArea.classList.remove('hidden'); 
      dom.filePreview.classList.add('hidden'); 
      dom.newsForm['existing-image-url'].value = ''; 
    }
    
    function switchTab(tabName) { 
      dom.tabs.forEach(tab => tab.classList.remove('active')); 
      dom.tabContents.forEach(content => content.classList.add('hidden')); 
      const activeTab = document.querySelector(`[data-tab="${tabName}"]`); 
      activeTab.classList.add('active'); 
      document.getElementById(`tab-${tabName}`).classList.remove('hidden'); 
    }
    
    function updateStats(data) { 
      const now = new Date(); 
      dom.stats.total.textContent = data.length; 
      dom.stats.recent.textContent = data.filter(n => new Date(n.created_at).getMonth() === now.getMonth()).length; 
      dom.stats.categories.textContent = [...new Set(data.map(n => n.categoria))].length; 
      dom.stats.users.textContent = Object.keys(USERS).length; 
    }
    
    function setDefaultDate() { 
      document.getElementById('news-date').valueAsDate = new Date(); 
    }
    
    function showNotification(message, type = 'info') { 
      const n = document.getElementById('notification'); 
      const c = { success: 'bg-green-500', error: 'bg-red-500', info: 'bg-blue-500' }; 
      n.className = `notification fixed top-5 right-5 p-4 rounded-lg shadow-lg text-white transform opacity-100 translate-x-0 ${c[type]}`; 
      n.textContent = message; 
      setTimeout(() => { n.style.transform = 'translateX(120%)'; n.style.opacity = '0'; }, 4000); 
    }
    
    function loadUsersList() { 
      const userCards = {
        'admin': {
          name: 'Administrador',
          realName: 'Marcelo',
          role: 'Administrador General',
          icon: 'ğŸ‘‘',
          color: 'from-blue-500 to-blue-600',
          permissions: ['GestiÃ³n completa', 'Todos los permisos', 'ConfiguraciÃ³n avanzada']
        },
        'editora': {
          name: 'Editora',
          realName: 'Silvia',
          role: 'Editora de Contenido',
          icon: 'âœï¸',
          color: 'from-purple-500 to-purple-600',
          permissions: ['Crear noticias', 'Editar contenido', 'GestiÃ³n de medios']
        }
      };

      dom.usersList.innerHTML = Object.keys(USERS).map(username => {
        const user = userCards[username];
        return `
          <div class="bg-gradient-to-r ${user.color} p-6 rounded-2xl text-white shadow-lg card-hover">
            <div class="flex items-center justify-between mb-4">
              <div class="flex items-center space-x-3">
                <div class="text-3xl">${user.icon}</div>
                <div>
                  <h3 class="font-bold text-lg">${user.name}</h3>
                  <p class="text-white/80 text-sm">${user.realName}</p>
                </div>
              </div>
              <div class="text-right">
                <span class="text-xs bg-white/20 px-2 py-1 rounded-full">${user.role}</span>
              </div>
            </div>
            <div class="space-y-1">
              <h4 class="font-semibold text-sm mb-2">Permisos:</h4>
              ${user.permissions.map(permission => `
                <div class="flex items-center text-xs">
                  <svg class="w-3 h-3 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                  </svg>
                  ${permission}
                </div>
              `).join('')}
            </div>
          </div>
        `;
      }).join('');
    }
    
    function handlePasswordChange(e) { 
      e.preventDefault(); 
      showNotification("FunciÃ³n no implementada aÃºn.", "info"); 
    }
    
    function exportData() { 
      if(allNewsData.length === 0) { 
        showNotification("No hay datos para exportar", "info"); 
        return; 
      } 
      const dataStr = JSON.stringify(allNewsData, null, 2); 
      const blob = new Blob([dataStr], {type: 'application/json'}); 
      const url = URL.createObjectURL(blob); 
      const a = document.createElement('a'); 
      a.href = url; 
      a.download = 'noticias_sochimt.json'; 
      a.click(); 
      URL.revokeObjectURL(url); 
    }
    
    function updateConnectionStatus(status) { 
      const statuses = { 
        connecting: { text: 'Conectando...', dot: 'bg-yellow-400', container: 'bg-yellow-200 text-yellow-800' }, 
        connected: { text: 'Conectado', dot: 'bg-green-500', container: 'bg-green-200 text-green-800' }, 
        disconnected: { text: 'Desconectado', dot: 'bg-red-500', container: 'bg-red-200 text-red-800' } 
      }; 
      const current = statuses[status] || statuses.disconnected; 
      const statusContainer = document.getElementById('connection-status'); 
      if (statusContainer) { 
        document.getElementById('status-dot').className = `w-3 h-3 rounded-full ${current.dot}`; 
        document.getElementById('status-text').textContent = current.text; 
        statusContainer.className = `flex items-center space-x-2 px-3 py-1 rounded-full text-sm font-bold transition-colors ${current.container}`; 
      } 
    }

    document.addEventListener('DOMContentLoaded', checkSession);
  </script>
</body>
</html>
